<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= event.name %></title> <!-- Dynamic title based on event name -->

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Your stylesheet -->
    <link rel="stylesheet" href="/stylesheets/style.css">
  </head>
  <body>
    <%- include('../partials/_nav') %>
    <main>
      <h1><%= event.name %></h1> <!-- Display event name -->

      <!-- ! Images -->
      <div id="myCarousel" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
          <% event.images.forEach((image, idx) => { %>
            <div class="carousel-item <%= idx === 0 && "active" %>">
              <img src="<%= image %>" alt="<%= event.name %> display image <%= idx + 1 %>">
            </div>
          <% }) %>
        </div>
        <a class="carousel-control-prev" href="#myCarousel" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#myCarousel" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>

      <!-- ! Attendees section -->
      <h3>Attending</h3>
      <div class="attending">
        <span><%= event.attendees.length %></span>
        <% if (user) { %>

          <!-- Check if any of the ids in the attendees array match the logged in user is -->
          <!-- If they do, then display the button that allows a user to delete their id from the array -->
          <% if (event.attendees.some(attendee => attendee.equals(user._id))) { %>
            <form action="/events/<%= event._id %>/attending?_method=DELETE" method="POST">
              <button class="btn-as-link"><img src="/images/attending.svg" alt="Remove attending status"></button>
            </form>

          <!-- If they don't appear, then the user is not currently in the attendees array -->
          <!-- In this case, we'll show the button that allows a user to add their id to the attendees array -->
          <% } else { %>
            <form action="/events/<%= event._id %>/attending" method="POST">
              <button class="btn-as-link"><img src="/images/not-attending.svg" alt="Add attending status"></button>
            </form>
          <% } %>
        <% } %>
      </div>

      <p><%= new Date(event.date).toDateString() %></p>
      <p><%= event.description %></p>
      
      <% if (user !== null && event.organiser._id.equals(user._id)) { %>
        <p>You own this event</p>
        <div class="event-btns">
          <!-- Form to delete event -->
          <form class="btn-form" action="/events/<%= event._id %>?_method=DELETE" method="POST">
            <button class="btn delete" type="submit">Delete <%= event.name %></button>
          </form>
    
          <!-- Link to edit form -->
          <a class="btn edit" href="/events/<%= event._id %>/edit">Edit <%= event.name %></a>
        </div>
      <% } else { %>
        <p>This is an event by <%= event.organiser.username %></p>  
      <% } %>

      <!-- Comment Section -->
      <h2>Comments</h2>

      <!-- Display Comments -->
      <% if (event.comments.length > 0) { %>
        <div class="comments">
          <% event.comments.forEach(comment => { %>
            <div class="comment">
              <p>
                <strong><%= comment.user.username %></strong> <small><%= new Date(comment.createdAt).toDateString() %></small><br>
                <%= comment.text %>
              </p>
              <% if (user && comment.user._id.equals(user._id)) { %>
                <form action="/events/<%= event._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST">
                  <button type="submit">üóëÔ∏è</button>
                </form>
              <% } %>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p>There are no comments yet.</p>
      <% } %>

      <!-- Create Comment -->
      <% if (user) { %>
        <form class="form" action="/events/<%= event._id %>/comments" method="POST">
          <label for="text">Text:</label>
          <input type="text" name="text" id="text">
          <% if (message) { %>
            <p><small class="error"><%= message %></small></p>
          <% } %> 
          <button class="btn" type="submit">Add Comment</button>
        </form>
      <% } else { %>
        <p><a class="link" href="/auth/sign-in">Sign in</a> to leave a comment</p>
      <% } %>

      <!-- Link to index -->
      <a class="link" href="/events">Back to Events</a>
    </main>



    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>